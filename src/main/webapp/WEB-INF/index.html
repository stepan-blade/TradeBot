<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Binance Demo Bot</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    body { background-color: #121212; color: #ffffff; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }

    /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
    .card { background-color: #1e1e1e; border: 1px solid #333; border-radius: 12px; margin-bottom: 1rem; color: #ffffff; }

    /* –¶–≤–µ—Ç–∞ –ø—Ä–∏–±—ã–ª–∏ */
    .profit-pos { color: #00ff88 !important; }
    .profit-neg { color: #ff4d4d !important; }
    .profit-pos, .profit-pos small { color: #00ff88 !important; }
    .profit-neg, .profit-neg small { color: #ff4d4d !important; }

    /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
    .stat-label { font-size: 0.8rem; color: #aaaaaa; text-transform: uppercase; letter-spacing: 1px; }
    .balance-val { font-size: calc(1.5rem + 1vw); font-weight: bold; line-height: 1.2; color: #ffffff; }

    /* –¢–ê–ë–õ–ò–¶–ê: */
    .table-responsive {
      width: 100%;
      overflow-x: auto;
      background-color: #1e1e1e;
      border-radius: 8px;
      border: 1px solid #333;
    }

    .table {
      width: 100% !important;
      margin-bottom: 0;
      color: #ffffff;
      border-collapse: collapse;
      table-layout: auto;
    }

    .table thead th {
      background-color: #252525 !important;
      color: #e0e0e0 !important;
      border-bottom: 2px solid #444;
      text-transform: uppercase;
      font-size: 0.8rem;
      padding: 12px 10px;
      font-weight: 600;
      white-space: nowrap;
    }

    .table td {
      background-color: #1e1e1e !important;
      color: #ffffff !important;
      border-bottom: 1px solid #333;
      vertical-align: middle;
      padding: 12px 10px;
    }

    /* –¢–µ–∫—Å—Ç "–°–¥–µ–ª–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ" –∏ –ø—É—Å—Ç—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è */
    .text-muted {
      color: #bdbdbd !important;
    }

    /* –î–∞—Ç–∞ */
    td[style*="color: #aaaaaa"] {
      color: #cccccc !important;
    }

    .sortable {
      cursor: pointer;
      position: relative;
      transition: color 0.2s;
    }

    .sortable:hover {
      color: #00ff88 !important;
    }

    /* –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–µ–Ω—é —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ "–≤—Å–ø–ª—ã–≤–∞—à–∫–∏" */
    .dropdown-menu {
      position: absolute !important;
      z-index: 1060 !important;
      margin: 0;
    }

    /* –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö: —á—Ç–æ–±—ã —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ —Å—Ö–ª–æ–ø—ã–≤–∞–ª–∞—Å—å —Å–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω–æ */
    @media (max-width: 768px) {
      .table {
        min-width: 900px;
      }
    }

    @media (max-width: 576px) {
      /* –£–º–µ–Ω—å—à–∞–µ–º padding —É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, —á—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –º–µ—Å—Ç–æ */
      .card.p-0.p-md-4.mb-4 .p-3 {
        padding: 10px !important;
      }

      /* –î–µ–ª–∞–µ–º —à—Ä–∏—Ñ—Ç —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ —á—É—Ç—å –º–µ–Ω—å—à–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
      #view-selector {
        padding-left: 8px;
        padding-right: 25px;
      }
    }

    .table-hover tbody tr:hover td { background-color: #383838 !important; }

    /*/------_-----NAVBAR--------------/*/
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –∏–∫–æ–Ω–∫–∏ –º–µ–Ω—é (—Ç—Ä–∏ –ø–æ–ª–æ—Å–∫–∏) */
    .menu-icon {
      width: 24px;
      height: 18px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
    }

    .menu-icon span {
      display: block;
      height: 2px;
      width: 100%;
      background-color: #ffffff;
      border-radius: 2px;
      transition: 0.3s;
    }

    /* –î–µ–ª–∞–µ–º —Å—Ä–µ–¥–Ω—é—é –ø–æ–ª–æ—Å–∫—É —á—É—Ç—å –∫–æ—Ä–æ—á–µ –¥–ª—è —Å—Ç–∏–ª—è */
    .menu-icon span:nth-child(2) {
      width: 75%;
      align-self: flex-end;
    }

    .menu-icon:hover span:nth-child(2) {
      width: 100%;
    }

    /* –¢–µ–∫—Å—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
    .uppercase-tracking {
      text-transform: uppercase;
      letter-spacing: 2px;
      font-size: 1.1rem;
    }

    /* –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Navbar */
    .navbar {
      background-color: #1a1a1a !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      border-radius: 16px;
      overflow: hidden;
      margin-top: 10px;
    }

    /* –§–∏–∫—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, —Ç–∞–∫ –∫–∞–∫ –º—ã –≤—ã–Ω–µ—Å–ª–∏ –Ω–∞–≤–±–∞—Ä –∏–∑ –Ω–µ–≥–æ */
    .container.py-3.py-md-5 {
      padding-top: 1rem !important;
    }

    /* –≠—Ñ—Ñ–µ–∫—Ç —Å—Ç–µ–∫–ª–∞ –¥–ª—è –º–µ–Ω—é */
    .glass-menu {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(18, 18, 18, 0.6); /* –¢–µ–º–Ω—ã–π –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω */
      backdrop-filter: blur(15px); /* –¢–æ —Å–∞–º–æ–µ —Ä–∞–∑–º—ã—Ç–∏–µ */
      -webkit-backdrop-filter: blur(15px);
      z-index: 1050;
      display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
      opacity: 0;
      transition: opacity 0.3s ease;
      align-items: center;
      justify-content: center;
    }

    .glass-menu.active {
      display: flex;
      opacity: 1;
    }

    .glass-content {
      width: 85%;
      max-width: 400px;
      padding: 2rem;
      border-radius: 24px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
    }

    .glass-item {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      margin-bottom: 10px;
      color: white;
      text-decoration: none;
      font-size: 1.1rem;
      border-radius: 12px;
      transition: all 0.2s ease;
      background: rgba(255, 255, 255, 0.03);
    }

    .glass-item:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #00ff88;
      transform: translateX(5px);
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –∏–∫–æ–Ω–∫–∏ –º–µ–Ω—é (–∫—Ä–µ—Å—Ç–∏–∫) */
    .menu-icon.open span:nth-child(1) {
      transform: translateY(8px) rotate(45deg);
    }
    .menu-icon.open span:nth-child(2) {
      opacity: 0;
    }
    .menu-icon.open span:nth-child(3) {
      transform: translateY(-8px) rotate(-45deg);
    }
    /*/-----------------------------------/*/

    .sortable {
      position: relative;
      cursor: pointer;
    }

    .filter-dot {
      display: none;
      width: 7px;
      height: 7px;
      background-color: #00ff88;
      border-radius: 50%;
      position: absolute;
      top: -2px;
      right: -10px;
      box-shadow: 0 0 6px rgba(0, 255, 136, 0.8);
    }

    #view-selector { background-color: #2d2d2d; border: 1px solid #444; color: white; border-radius: 8px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
</head>
<body>

<div class="container py-3 py-md-5">
  <nav class="navbar navbar-dark bg-dark border-bottom border-secondary border-opacity-25 mb-4 py-3">
    <div class="container">
      <div class="d-flex align-items-center">
        <div class="bg-primary bg-gradient rounded-3 p-2 me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
          <i class="bi bi-cpu-fill text-white fs-5"></i>
        </div>
        <div>
          <h1 class="h5 mb-0 fw-bold text-white uppercase-tracking">–ì–ª–∞–≤–Ω–∞—è</h1>
          <span class="text-info small d-block" style="font-size: 0.7rem; letter-spacing: 1px;">SYSTEM ACTIVE</span>
        </div>
      </div>

      <button class="btn btn-link text-white p-0 shadow-none" type="button" onclick="toggleMenu()" style="text-decoration: none; z-index: 1100;">
        <div class="menu-icon" id="menuIcon">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </button>
    </div>
  </nav>

  <div class="glass-menu" id="glassMenu">
    <div class="glass-content">
      <div class="menu-items">
        <div class="text-muted small text-uppercase mb-4 mt-5" style="letter-spacing: 3px;">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
        <a href="/settings" class="glass-item"><i class="bi bi-sliders me-3"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞</a>
        <a href="/h2-console" target="_blank" class="glass-item"><i class="bi bi-database me-3"></i>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</a>
        <div class="border-bottom border-white border-opacity-10 my-4"></div>
        <form action="/logout" method="post">
          <button type="submit" class="glass-item text-danger border-0 bg-transparent w-100 text-start">
            <i class="bi bi-box-arrow-right me-3"></i>–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
          </button>
        </form>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-6">
      <div class="card p-3 p-md-4 h-100 d-flex flex-column">
        <div class="stat-label mb-1">–ë–∞–ª–∞–Ω—Å</div>
        <div id="balance" class="balance-val text-truncate mb-1">0.00 $</div>
        <div id="percent-change" class="fw-bold fs-6 mb-3">+0.00%</div>

        <div id="total-pnl-container" class="mt-auto pt-3 border-top border-secondary border-opacity-25" style="display: none;">
          <div class="stat-label mb-1">PnL –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫:</div>
          <div id="total-pnl-val" class="fw-bold fs-6 lh-1">0.00 $ (0.00%)</div>
        </div>
      </div>
    </div>

    <div class="col-6">
      <div class="card p-3 p-md-4 h-100 d-flex flex-column shadow-sm">
        <div class="mb-2">
          <div class="stat-label mb-1">–°—Ç–∞—Ç—É—Å –±–æ—Ç–∞</div>
          <div class="d-flex align-items-center bg-dark px-2 py-1 rounded-pill w-fit-content" style="--bs-bg-opacity: .5; width: fit-content;">
            <div class="spinner-grow text-success spinner-grow-sm me-2" style="width: 8px; height: 8px;"></div>
            <span class="text-success fw-bold small">Online</span>
          </div>
        </div>

        <div id="today-stats-container" class="mt-auto pt-3 border-top border-secondary border-opacity-25">
          <div class="stat-label mb-1">PNL —Å–µ–≥–æ–¥–Ω—è:</div>
          <div id="today-profit" class="fw-bold fs-6 lh-1 text-white">0.00 $ (0.00%)</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card p-2 p-md-4 mb-4">
    <div class="d-flex justify-content-between align-items-center p-2 mb-0">
      <h5 class="mb-0">–ì—Ä–∞—Ñ–∏–∫ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏</h5>
      <button class="btn btn-outline-secondary btn-sm" onclick="resetZoom()">
        <i class="bi bi-arrows-angle-contract"></i> –°–±—Ä–æ—Å –∑—É–º–∞
      </button>
    </div>
    <div style="height: 250px; position: relative;">
      <canvas id="balanceChart"></canvas>
    </div>
  </div>

  <div id="cooldown-section" class="mb-3">
    <div id="cooldown-container" class="d-flex flex-wrap"></div>
  </div>

  <div class="card mb-4 overflow-hidden">
    <div class="p-3 border-bottom border-secondary border-opacity-25">
      <div class="d-flex align-items-center justify-content-between gap-2">
        <div style="flex: 1; max-width: 180px;">
          <select id="view-selector" class="form-select form-select-sm" onchange="changeView()" style="height: 38px; font-size: 0.85rem; background-color: #2d2d2d; border-color: #444; color: white;">
            <option value="OPEN" selected>üöÄ –°–¥–µ–ª–∫–∏</option>
            <option value="CLOSED">üìú –ò—Å—Ç–æ—Ä–∏—è</option>
          </select>
        </div>
        <div class="text-end" style="white-space: nowrap;">
          <div class="stat-label" style="font-size: 0.65rem; opacity: 0.7;">–í –æ–±–æ—Ä–æ—Ç–µ</div>
          <div id="in-trade" class="fw-bold text-info" style="font-size: 1.1rem; line-height: 1;">0.00 $</div>
        </div>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
        <tr>
          <th style="width: 12%">
            <div class="dropdown" id="dateDropdown">
              <span class="dropdown-toggle sortable" data-bs-toggle="dropdown" data-bs-auto-close="outside">
                –î–∞—Ç–∞ <span id="dot-date" class="filter-dot"></span>
              </span>
              <div class="dropdown-menu dropdown-menu-dark p-3" style="min-width: 250px;" onclick="event.stopPropagation()">
                <div class="mb-2">
                  <label class="small text-muted mb-1 d-block">–û—Ç:</label>
                  <input type="date" id="filter-date-start" class="form-control form-control-sm bg-dark text-white border-secondary">
                </div>
                <div class="mb-3">
                  <label class="small text-muted mb-1 d-block">–î–æ:</label>
                  <input type="date" id="filter-date-end" class="form-control form-control-sm bg-dark text-white border-secondary">
                </div>
                <div class="d-flex gap-2">
                  <button class="btn btn-primary btn-sm flex-grow-1" onclick="applyDateFilter()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                  <button class="btn btn-outline-light btn-sm" onclick="resetFilter('date')" title="–°–±—Ä–æ—Å–∏—Ç—å">
                    <i class="bi bi-arrow-counterclockwise"></i>
                  </button>
                </div>
              </div>
            </div>
          </th>

          <th style="width: 10%">–í—Ä–µ–º—è</th>

          <th style="width: 15%">
            <div class="dropdown">
              <span class="dropdown-toggle sortable" data-bs-toggle="dropdown">
                –ê–∫—Ç–∏–≤ <span id="dot-asset" class="filter-dot"></span>
              </span>
              <ul class="dropdown-menu dropdown-menu-dark" id="filter-asset-list" style="max-height: 300px; overflow-y: auto;"></ul>
            </div>
          </th>

          <th style="width: 10%">–û–±—ä–µ–º</th>

          <th style="width: 10%">
            <div class="dropdown">
              <span class="dropdown-toggle sortable" data-bs-toggle="dropdown">
                –¢–∏–ø <span id="dot-type" class="filter-dot"></span>
              </span>
              <ul class="dropdown-menu dropdown-menu-dark">
                <li><a class="dropdown-item" href="javascript:void(0)" onclick="setFilter('type', 'ALL')">–í—Å–µ</a></li>
                <li><a class="dropdown-item" href="javascript:void(0)" onclick="setFilter('type', 'LONG')">LONG</a></li>
                <li><a class="dropdown-item" href="javascript:void(0)" onclick="setFilter('type', 'SHORT')">SHORT</a></li>
              </ul>
            </div>
          </th>

          <th style="width: 10%">–í—Ö–æ–¥</th>
          <th style="width: 10%" id="col-exit-header">–í—ã—Ö–æ–¥</th>

          <th style="width: 13%" id="col-result-cell">
            <div class="dropdown">
              <span class="dropdown-toggle sortable" data-bs-toggle="dropdown">
                –†–µ–∑—É–ª—å—Ç–∞—Ç <span id="dot-result" class="filter-dot"></span>
              </span>
              <ul class="dropdown-menu dropdown-menu-dark">
                <li><a class="dropdown-item" href="javascript:void(0)" onclick="setFilter('result', 'ALL')">–í—Å–µ</a></li>
                <li><a class="dropdown-item" href="javascript:void(0)" onclick="setFilter('result', 'WIN')">–ü—Ä–∏–±—ã–ª—å–Ω—ã–µ</a></li>
                <li><a class="dropdown-item" href="javascript:void(0)" onclick="setFilter('result', 'LOSS')">–£–±—ã—Ç–æ—á–Ω—ã–µ</a></li>
              </ul>
            </div>
          </th>

          <th style="width: 10%" id="col-action-header">–î–µ–π—Å—Ç–≤–∏–µ</th>
        </tr>
        </thead>
        <tbody id="trade-history">
        </tbody>
      </table>
    </div>

    <div class="d-flex justify-content-center p-3" id="pagination-controls"></div>
  </div>
</div>

<script>
  let currentPage = 1;
  const recordsPerPage = 10;
  let fullHistory = [];
  let balanceChart;
  let currentView = 'OPEN';

  let sortDirection = {
    date: true,
    asset: true,
    type: true,
    profit: true
  };

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
  let filters = {
    asset: 'ALL',
    type: 'ALL',
    result: 'ALL'
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å" –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
  function applyDateFilter() {
    renderTable(); // –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é

    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –¥–∞—Ç—ã
    const dateDropdownEl = document.querySelector('#dateDropdown [data-bs-toggle="dropdown"]');
    const instance = bootstrap.Dropdown.getInstance(dateDropdownEl);
    if (instance) instance.hide();
  }

  function setFilter(key, value) {
    filters[key] = value;
    currentPage = 1;
    renderTable();
  }

  function resetFilter(type) {
    if (type === 'date') {
      document.getElementById('filter-date-start').value = '';
      document.getElementById('filter-date-end').value = '';
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞ –ø–µ—Ä–≤—É—é
      currentPage = 1;
      renderTable();
    }
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –≤–∞–ª—é—Ç–Ω—ã—Ö –ø–∞—Ä
  function updateAssetFilterList() {
    const assetList = document.getElementById('filter-asset-list');
    if (!assetList) return;

    const uniqueAssets = [...new Set(fullHistory.map(t => t.asset))];
    let html = `<li><a class="dropdown-item" href="javascript:void(0)" onclick="setFilter('asset', 'ALL')">–í—Å–µ –ø–∞—Ä—ã</a></li>`;
    uniqueAssets.forEach(asset => {
      html += `<li><a class="dropdown-item" href="javascript:void(0)" onclick="setFilter('asset', '${asset}')">${asset}</a></li>`;
    });
    assetList.innerHTML = html;
  }

  function changeView() {
    currentView = document.getElementById('view-selector').value;

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–æ–∫
    filters.asset = 'ALL';
    filters.type = 'ALL';
    filters.result = 'ALL';

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏)
    document.getElementById('filter-date-start').value = '';
    document.getElementById('filter-date-end').value = '';

    currentPage = 1;
    renderTable();
  }

  async function updateDashboard() {
    updateCooldowns();
    try {
      const response = await fetch('/api/status?nocache=' + Date.now());
      const data = await response.json();

      // 1. –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫
      fullHistory = data.history || [];

      // 2. –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å (–±–µ—Ä–µ–º –∏–∑ –ø–æ–ª—è balance, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–∏—Å–ª–∞–ª —Å–µ—Ä–≤–µ—Ä)
      const currentBalance = data.balance || 1000.0;
      const initialDeposit = 1000.0;

      // 3. –†–ê–°–ß–ï–¢ –ò –í–´–í–û–î –ü–†–û–§–ò–¢–ê –ó–ê –°–ï–ì–û–î–ù–Ø
      const todayPrefix = new Date().toLocaleDateString('ru-RU');
      const todayProfit = fullHistory
              .filter(t => t.status === 'CLOSED' && t.exitTime && t.exitTime.startsWith(todayPrefix))
              .reduce((sum, t) => sum + (t.profit || 0), 0);

      const todayProfitEl = document.getElementById('today-profit');

      // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
      const startBalanceToday = currentBalance - todayProfit;
      const todayPercent = startBalanceToday > 0 ? (todayProfit / startBalanceToday) * 100 : 0;

      if (todayProfit > 0) {
        todayProfitEl.innerText = `+${todayProfit.toFixed(2)} $ (+${todayPercent.toFixed(2)}%)`;
        todayProfitEl.className = "profit-pos fw-bold fs-6 lh-1";
      } else if (todayProfit < 0) {
        todayProfitEl.innerText = `${todayProfit.toFixed(2)} $ (${todayPercent.toFixed(2)}%)`;
        todayProfitEl.className = "profit-neg fw-bold fs-6 lh-1";
      } else {
        todayProfitEl.innerText = `0.00 $ (0.00%)`;
        todayProfitEl.className = "text-white fw-bold fs-6 lh-1";
      }

      // 4. –†–ê–°–ß–ï–¢ –û–ë–©–ï–ì–û –ü–õ–ê–í–ê–Æ–©–ï–ì–û PNL –ò –û–ë–û–†–û–¢–ê
      const openTrades = fullHistory.filter(t => t.status === 'OPEN');
      let totalUnrealizedPnL = 0;
      const totalInTrade = openTrades.reduce((sum, t) => sum + (t.volume || 0), 0);

      const inTradeEl = document.getElementById('in-trade');
      if (inTradeEl) {
        inTradeEl.innerText = totalInTrade.toFixed(2) + " $";
      }

      openTrades.forEach(trade => {
        const currentPrice = trade.exitPrice || trade.entryPrice || 0;
        const entryPrice = trade.entryPrice || 0;
        if (entryPrice > 0) {
          let pnlPercent = ((currentPrice - entryPrice) / entryPrice) * 100;
          if (trade.type === 'SHORT') pnlPercent *= -1;
          totalUnrealizedPnL += trade.volume * ((pnlPercent - 0.2) / 100);
        }
      });

      const pnlContainer = document.getElementById('total-pnl-container');
      const pnlValEl = document.getElementById('total-pnl-val');

      if (openTrades.length > 0) {
        pnlContainer.style.display = 'block';
        const unrealizedPercent = (totalUnrealizedPnL / currentBalance) * 100;
        const sign = totalUnrealizedPnL >= 0 ? "+" : "";
        pnlValEl.innerText = `${sign}${totalUnrealizedPnL.toFixed(2)} $ (${sign}${unrealizedPercent.toFixed(2)}%)`;
        pnlValEl.className = totalUnrealizedPnL >= 0 ? "profit-pos fw-bold fs-6 lh-1" : "profit-neg fw-bold fs-6 lh-1";
      } else {
        pnlContainer.style.display = 'none';
      }

      // 5. –û–ë–©–ò–ô –ü–†–ò–†–û–°–¢ –ë–ê–õ–ê–ù–°–ê
      const diffUsdt = currentBalance - initialDeposit;
      const calculatedPercent = (diffUsdt / initialDeposit) * 100;

      document.getElementById('balance').innerText = currentBalance.toFixed(2) + " $";

      const percentEl = document.getElementById('percent-change');
      percentEl.innerText = (calculatedPercent >= 0 ? "+" : "") + calculatedPercent.toFixed(2) + "%";
      percentEl.className = calculatedPercent >= 0 ? "profit-pos fw-bold" : "profit-neg fw-bold";

      // 6. –û–ë–ù–û–í–õ–ï–ù–ò–ï –ì–†–ê–§–ò–ö–ê
      if (data.balanceHistory && Array.isArray(data.balanceHistory)) {
        updateChart(data.balanceHistory);
      }

      renderTable();
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞—à–±–æ—Ä–¥–∞:", error);
    }
  }

  function renderTable() {
    updateAssetFilterList();

    const historyBody = document.getElementById('trade-history');
    if (!historyBody) return;

    // –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–î–ò–ö–ê–¢–û–†–û–í (–¢–û–ß–ï–ö)
    const start = document.getElementById('filter-date-start').value;
    const end = document.getElementById('filter-date-end').value;

    // –î–∞—Ç–∞
    document.getElementById('dot-date').style.display = (start || end) ? 'inline-block' : 'none';
    // –ê–∫—Ç–∏–≤
    document.getElementById('dot-asset').style.display = (filters.asset !== 'ALL') ? 'inline-block' : 'none';
    // –¢–∏–ø
    document.getElementById('dot-type').style.display = (filters.type !== 'ALL') ? 'inline-block' : 'none';
    // –†–µ–∑—É–ª—å—Ç–∞—Ç (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ DOM)
    const dotRes = document.getElementById('dot-result');
    if (dotRes) dotRes.style.display = (filters.result !== 'ALL') ? 'inline-block' : 'none';

    // 1. –ü–æ–ª—É—á–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å—Ç–∞—Ç—É—Å—É
    let data = fullHistory.filter(trade => trade.status === currentView);

    // 2. –°–û–†–¢–ò–†–û–í–ö–ê
    data.sort((a, b) => {
      try {
        // –í—ã–±–∏—Ä–∞–µ–º –≤—Ä–µ–º—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –∑–∞–∫—Ä—ã—Ç–∞ —Å–¥–µ–ª–∫–∞ –∏–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞
        const timeA_raw = (currentView === 'CLOSED' && a.exitTime) ? a.exitTime : a.time;
        const timeB_raw = (currentView === 'CLOSED' && b.exitTime) ? b.exitTime : b.time;

        if (!timeA_raw || !timeB_raw) return 0;

        // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º "16.01.2026 | 10:00" –≤ –æ–±—ä–µ–∫—Ç Date –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        const parseDate = (str) => {
          const [datePart, timePart] = str.split(' | ');
          const [d, m, y] = datePart.split('.');
          const [hh, mm] = timePart ? timePart.split(':') : ['00', '00'];
          return new Date(y, m - 1, d, hh, mm).getTime();
        };

        return parseDate(timeB_raw) - parseDate(timeA_raw);
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏:", e);
        return 0;
      }
    });

    // 3. –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
    if (filters.asset !== 'ALL') data = data.filter(t => t.asset === filters.asset);
    if (filters.type !== 'ALL') data = data.filter(t => t.type === filters.type);
    if (filters.result !== 'ALL') {
      if (filters.result === 'WIN') data = data.filter(t => t.profit > 0);
      if (filters.result === 'LOSS') data = data.filter(t => t.profit < 0);
    }

    // 4. –§–∏–ª—å—Ç—Ä –¥–∞—Ç
    const startDateInput = document.getElementById('filter-date-start').value;
    const endDateInput = document.getElementById('filter-date-end').value;

    if (startDateInput || endDateInput) {
      data = data.filter(t => {
        // –í–ê–ñ–ù–û: –±–µ—Ä–µ–º –ø–æ–ª–µ entryTime, —Ç–∞–∫ –∫–∞–∫ –∏–º–µ–Ω–Ω–æ –æ–Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞—Ç—É –≤ –∏—Å—Ç–æ—Ä–∏–∏
        const timeStr = (currentView === 'CLOSED' && t.exitTime) ? t.exitTime : (t.entryTime || t.time);

        if (!timeStr || typeof timeStr !== 'string' || !timeStr.includes('.')) return false;

        try {
          // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–∞—Ç—É "16.01.2026" –∏–∑ —Å—Ç—Ä–æ–∫–∏ "16.01.2026 | 10:00"
          const datePart = timeStr.split(' | ')[0];
          const parts = datePart.split('.');

          // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –¥–∞—Ç—ã (–≥–æ–¥, –º–µ—Å—è—Ü-1, –¥–µ–Ω—å)
          const tradeDate = new Date(parts[2], parts[1] - 1, parts[0]);
          tradeDate.setHours(0, 0, 0, 0);

          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞—Ç—ã "–û–¢"
          if (startDateInput) {
            const start = new Date(startDateInput);
            start.setHours(0, 0, 0, 0);
            if (tradeDate < start) return false;
          }

          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞—Ç—ã "–î–û"
          if (endDateInput) {
            const end = new Date(endDateInput);
            end.setHours(0, 0, 0, 0);
            if (tradeDate > end) return false;
          }

          return true;
        } catch (e) {
          console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞:", e);
          return false;
        }
      });
    }

    // 5. –û—á–∏—Å—Ç–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    historyBody.innerHTML = '';
    const actionHeader = document.getElementById('col-action-header');
    if (actionHeader) {
      // –≠—Ç–∞ –∫–æ–ª–æ–Ω–∫–∞ –≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∏–¥–Ω–∞
      actionHeader.style.display = 'table-cell';
      actionHeader.innerHTML = '–î–µ–π—Å—Ç–≤–∏–µ';
    }

    const resultCell = document.getElementById('col-result-cell');

    if (currentView === 'OPEN') {
      // –î–õ–Ø –ê–ö–¢–ò–í–ù–´–• –°–î–ï–õ–û–ö: –ü—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∫–ª–∏–∫–∞/—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
      const resultCell = document.getElementById('col-result-cell');
      if (resultCell) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ —Ñ–∏–ª—å—Ç—Ä (WIN –∏–ª–∏ LOSS)
        const dotVisible = filters.result !== 'ALL' ? 'inline-block' : 'none';

        if (currentView === 'OPEN') {
          // –í —Ä–µ–∂–∏–º–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç + —Ç–æ—á–∫–∞
          resultCell.innerHTML = `–¢–µ–∫—É—â–∏–π PnL <span id="dot-result" class="filter-dot" style="display: ${dotVisible}"></span>`;
        } else {
          // –í —Ä–µ–∂–∏–º–µ –∏—Å—Ç–æ—Ä–∏–∏ ‚Äî –¥—Ä–æ–ø–¥–∞—É–Ω + —Ç–æ—á–∫–∞ –≤–Ω—É—Ç—Ä–∏
          resultCell.innerHTML = `
            <div class="dropdown">
              <span class="dropdown-toggle sortable" data-bs-toggle="dropdown">
                –†–µ–∑—É–ª—å—Ç–∞—Ç <span id="dot-result" class="filter-dot" style="display: ${dotVisible}"></span>
              </span>
              <ul class="dropdown-menu dropdown-menu-dark">
                <li><a class="dropdown-item" href="javascript:void(0)" onclick="setFilter('result', 'ALL')">–í—Å–µ</a></li>
                <li><a class="dropdown-item" href="javascript:void(0)" onclick="setFilter('result', 'WIN')">–ü—Ä–∏–±—ã–ª—å–Ω—ã–µ</a></li>
                <li><a class="dropdown-item" href="javascript:void(0)" onclick="setFilter('result', 'LOSS')">–£–±—ã—Ç–æ—á–Ω—ã–µ</a></li>
              </ul>
            </div>`;
        }
      }
    } else {
      // –î–õ–Ø –ò–°–¢–û–†–ò–ò: –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
      if (resultCell) {
        resultCell.innerHTML = `
            <div class="dropdown">
              <span class="dropdown-toggle sortable" data-bs-toggle="dropdown">–†–µ–∑—É–ª—å—Ç–∞—Ç</span>
              <ul class="dropdown-menu dropdown-menu-dark">
                <li><a class="dropdown-item" href="javascript:void(0)" onclick="setFilter('result', 'ALL')">–í—Å–µ</a></li>
                <li><a class="dropdown-item" href="javascript:void(0)" onclick="setFilter('result', 'WIN')">–ü—Ä–∏–±—ã–ª—å–Ω—ã–µ</a></li>
                <li><a class="dropdown-item" href="javascript:void(0)" onclick="setFilter('result', 'LOSS')">–£–±—ã—Ç–æ—á–Ω—ã–µ</a></li>
              </ul>
            </div>`;
      }
      document.getElementById('col-exit-header').innerText = '–í—ã—Ö–æ–¥';
      if (actionHeader) actionHeader.style.display = 'none';
    }

    if (data.length === 0) {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º colspan="12", —á—Ç–æ–±—ã –ø–µ—Ä–µ–∫—Ä—ã—Ç—å –ª—é–±–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–æ–Ω–æ–∫ —Å –∑–∞–ø–∞—Å–æ–º
      historyBody.innerHTML = `
        <tr>
            <td colspan="12" class="text-center py-5 text-muted" style="background-color: #1e1e1e !important;">
                <i class="bi bi-search d-block mb-2" style="font-size: 2rem; opacity: 0.3;"></i>
                –°–¥–µ–ª–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
            </td>
        </tr>`;
      renderPagination(0);
      return;
    }

    // 6. –ü–∞–≥–∏–Ω–∞—Ü–∏—è
    const startIndex = (currentPage - 1) * recordsPerPage;
    const paginatedItems = data.slice(startIndex, startIndex + recordsPerPage);

    // 7. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç—Ä–æ–∫
    paginatedItems.forEach(trade => {
      if (!trade) return;

      const row = document.createElement('tr');
      const timeFull = trade.entryTime || "‚Äî | ‚Äî";
      const timeParts = timeFull.split(" | ");
      const entryDate = timeParts[0] || "‚Äî";
      const entryTime = timeParts[1] || "‚Äî";

      let timeDisplay = "";
      if (currentView === 'OPEN') {
        timeDisplay = entryTime;
      } else {
        let exitTimeOnly = "‚Äî";
        if (trade.exitTime && trade.exitTime.includes(" | ")) {
          exitTimeOnly = trade.exitTime.split(" | ")[1];
        }
        timeDisplay = `<div class="d-flex align-items-center gap-1">
            <small class="text-muted">${entryTime}</small>
            <i class="bi bi-arrow-right text-secondary" style="font-size: 0.7rem;"></i>
            <span>${exitTimeOnly}</span>
        </div>`;
      }

      // –†–ê–°–ß–ï–¢ –¶–ï–ù–´ –ò –ü–†–û–§–ò–¢–ê
      const entryPrice = parseFloat(trade.entryPrice) || 0;
      const displayPrice = parseFloat(trade.exitPrice) || entryPrice;
      const tradeVolume = parseFloat(trade.volume) || 0;

      // –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ —Ü–µ–Ω—ã –∏–¥–µ–Ω—Ç–∏—á–Ω—ã –∏ —ç—Ç–æ OPEN —Å–¥–µ–ª–∫–∞,
// –≤–æ–∑–º–æ–∂–Ω–æ, –¥–∞–Ω–Ω—ã–µ —Å –±—ç–∫–µ–Ω–¥–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç "–ø–ª–æ—Å–∫–∏–µ"
      if (currentView === 'OPEN' && displayPrice === entryPrice) {
        console.warn(`–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –¶–µ–Ω–∞ –¥–ª—è ${trade.asset} –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å —Å –º–æ–º–µ–Ω—Ç–∞ –≤—Ö–æ–¥–∞.`);
      }

      // –°—á–∏—Ç–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã
      const rawProfitPercent = entryPrice !== 0 ? ((displayPrice - entryPrice) / entryPrice) * 100 : 0;
      let finalPercent = trade.type === 'SHORT' ? -rawProfitPercent : rawProfitPercent;

      let profitText, profitClass = "";

      if (currentView === 'OPEN') {
        // –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫
        const currentProfitUsdt = tradeVolume * (finalPercent / 100);
        const signUsdt = currentProfitUsdt >= 0 ? "+" : "";

        profitText = `${signUsdt}${currentProfitUsdt.toFixed(2)} $`;
        profitClass = finalPercent > 0 ? "profit-pos" : (finalPercent < 0 ? "profit-neg" : "text-white");
      } else {
        // –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
        const profit = trade.profit || 0;
        finalPercent = (tradeVolume > 0) ? (profit / tradeVolume) * 100 : 0;
        profitText = (profit >= 0 ? "+" : "") + profit.toFixed(2) + " $";
        //profitText = `${signUsdt}${currentProfitUsdt.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 4 })} $`;
        profitClass = profit > 0 ? "profit-pos" : (profit < 0 ? "profit-neg" : "text-white");
      }

      const signPercent = finalPercent > 0 ? "+" : "";
      const actionCell = currentView === 'OPEN' ? `<td><button class="btn btn-outline-danger btn-sm w-100" onclick="manualClose('${trade.asset}')">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button></td>` : '';

      // –ó–ê–ü–û–õ–ù–ï–ù–ò–ï –°–¢–†–û–ö–ò (–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ tradeVolume)
      row.innerHTML = `
        <td class="small text-muted">${entryDate}</td>
        <td style="white-space: nowrap;">${timeDisplay}</td>
        <td><span class="badge bg-secondary">${trade.asset || '‚Äî'}</span></td>
        <td class="fw-bold text-info">${tradeVolume.toFixed(2)} $</td>
        <td><span class="badge ${trade.type === 'LONG' ? 'bg-success' : 'bg-danger'}">${trade.type || '‚Äî'}</span></td>
        <td style="white-space: nowrap;">${entryPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 8 })}</td>
  <td style="white-space: nowrap;">${displayPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 8 })}</td>
        <td class="${profitClass} fw-bold">
            ${profitText}<br>
            <small style="color: inherit;">(${signPercent}${finalPercent.toFixed(2)}%)</small>
        </td>
        ${actionCell}
      `;
      historyBody.appendChild(row);
    });

    renderPagination(data.length);
  }

  // –†—É—á–Ω–æ–µ –∑–∞–≤–µ—Ä–ø—à–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∏
  async function manualClose(symbol) {
    try {
      const response = await fetch(`/api/preview-close?symbol=${symbol}`);
      if (!response.ok) throw new Error("Trade not found");

      const data = await response.json();

      const profitText = data.profitUsdt >= 0 ? `+${data.profitUsdt}` : `${data.profitUsdt}`;
      const emoji = data.profitUsdt >= 0 ? "‚úÖ" : "‚ö†Ô∏è";

      const confirmMsg = `–ó–∞–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é ${symbol}?\n\n` +
              `–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞: ${data.currentPrice}\n` +
              `–û–∂–∏–¥–∞–µ–º—ã–π –ø—Ä–æ—Ñ–∏—Ç: ${profitText} $ (${data.percent}%)\n` +
              `*—Å —É—á–µ—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–∏ 0.2% ${emoji}`;

      if (confirm(confirmMsg)) {
        const closeRes = await fetch(`/api/close-trade?symbol=${symbol}`, { method: 'POST' });
        if (closeRes.ok) {
          updateDashboard();
        } else {
          alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–¥–µ–ª–∫–∏");
        }
      }
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–µ–≤—å—é:", error);
      // –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ —Å –ø—Ä–µ–≤—å—é, –ø—Ä–æ—Å—Ç–æ —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –æ–±—ã—á–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
      if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–∫—Ä—ã—Ç—å ${symbol} –≤—Ä—É—á–Ω—É—é?`)) {
        const res = await fetch(`/api/close-trade?symbol=${symbol}`, { method: 'POST' });
        if (res.ok) updateDashboard();
      }
    }
  }

  function renderPagination(totalLength) {
    const controls = document.getElementById('pagination-controls');
    controls.innerHTML = '';
    const totalPages = Math.ceil(totalLength / recordsPerPage);
    if (totalPages <= 1) return;

    const navGroup = document.createElement('div');
    navGroup.className = 'btn-group';

    // –ö–Ω–æ–ø–∫–∞ "–í —Å–∞–º—ã–π –∑–∞–ø—É—Å–∫"
    const firstBtn = document.createElement('button');
    firstBtn.className = `btn btn-sm btn-outline-secondary ${currentPage === 1 ? 'disabled' : ''}`;
    firstBtn.innerHTML = '<i class="bi bi-chevron-double-left"></i>';
    firstBtn.onclick = () => { currentPage = 1; renderTable(); };
    navGroup.appendChild(firstBtn);

    // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
    const prevBtn = document.createElement('button');
    prevBtn.className = `btn btn-sm btn-outline-secondary ${currentPage === 1 ? 'disabled' : ''}`;
    prevBtn.innerHTML = '<i class="bi bi-chevron-left"></i>';
    prevBtn.onclick = () => { if(currentPage > 1) { currentPage--; renderTable(); } };
    navGroup.appendChild(prevBtn);

    // –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –∏ —Å–æ—Å–µ–¥–Ω–∏–µ)
    for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
      const btn = document.createElement('button');
      btn.innerText = i;
      btn.className = `btn btn-sm ${i === currentPage ? 'btn-primary' : 'btn-outline-secondary'}`;
      btn.onclick = () => { currentPage = i; renderTable(); };
      navGroup.appendChild(btn);
    }

    // –ö–Ω–æ–ø–∫–∞ "–í–ø–µ—Ä–µ–¥"
    const nextBtn = document.createElement('button');
    nextBtn.className = `btn btn-sm btn-outline-secondary ${currentPage === totalPages ? 'disabled' : ''}`;
    nextBtn.innerHTML = '<i class="bi bi-chevron-right"></i>';
    nextBtn.onclick = () => { if(currentPage < totalPages) { currentPage++; renderTable(); } };
    navGroup.appendChild(nextBtn);

    // –ö–Ω–æ–ø–∫–∞ "–í —Å–∞–º—ã–π –∫–æ–Ω–µ—Ü"
    const lastBtn = document.createElement('button');
    lastBtn.className = `btn btn-sm btn-outline-secondary ${currentPage === totalPages ? 'disabled' : ''}`;
    lastBtn.innerHTML = '<i class="bi bi-chevron-double-right"></i>';
    lastBtn.onclick = () => { currentPage = totalPages; renderTable(); };
    navGroup.appendChild(lastBtn);

    controls.appendChild(navGroup);
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ –∑—É–º–∞
  function resetZoom() {
    if (balanceChart) {
      balanceChart.resetZoom();
    }
  }

  function updateChart(balanceData) {
    const chartCanvas = document.getElementById('balanceChart');
    if (!chartCanvas) return;
    const ctx = chartCanvas.getContext('2d');

    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∏–∑ HTML –¥–ª—è —Ç–æ—á–∫–∏ "–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"
    const balanceText = document.getElementById('balance').innerText;
    const currentBalance = parseFloat(balanceText.replace(' $', '')) || 1000.0;

    let formattedData = [];

    if (!balanceData || balanceData.length === 0) {
      // –¢–æ—á–∫–∞ "–ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ" –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
      formattedData = [{
        x: new Date(),
        y: currentBalance
      }];
    } else {
      formattedData = balanceData.map(item => ({
        x: new Date(item.timestamp),
        y: Number(item.balance)
      })).sort((a, b) => a.x - b.x);
    }

    if (balanceChart && balanceChart.data && balanceChart.data.datasets) {
      balanceChart.data.datasets[0].data = formattedData;
      balanceChart.update('none');
    } else {
      // –ï—Å–ª–∏ –≥—Ä–∞—Ñ–∏–∫ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω –∏–ª–∏ –±—ã–ª —É–¥–∞–ª–µ–Ω
      balanceChart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [{
            label: '–ë–∞–ª–∞–Ω—Å $',
            data: formattedData,
            borderColor: '#00ff88',
            backgroundColor: 'rgba(0, 255, 136, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 4,
            pointBackgroundColor: '#00ff88'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'minute',
                displayFormats: { minute: 'HH:mm' }
              },
              grid: { color: 'rgba(255, 255, 255, 0.05)' }
            },
            y: {
              grid: { color: 'rgba(255, 255, 255, 0.05)' },
              // –ß—Ç–æ–±—ã –æ–¥–Ω–∞ —Ç–æ—á–∫–∞ –Ω–µ –ø—Ä–∏–ª–∏–ø–∞–ª–∞ –∫ –∫—Ä–∞—è–º
              suggestedMin: currentBalance - 10,
              suggestedMax: currentBalance + 10
            }
          },
          plugins: {
            legend: { display: false },
            zoom: {
              pan: {
                enabled: true,
                mode: 'x',
                threshold: 10
              },
              zoom: {
                wheel: { enabled: true },
                pinch: { enabled: true },
                mode: 'x',
              }
            }
          }
        }
      });
    }
  }

  async function updateCooldowns() {
    try {
      const res = await fetch('/api/cooldowns');
      const data = await res.json();
      const container = document.getElementById('cooldown-container');
      container.innerHTML = '';
      Object.entries(data).forEach(([symbol, time]) => {
        container.innerHTML += `<span class="badge rounded-pill bg-warning text-dark me-2 mb-2"><i class="bi bi-clock"></i> ${symbol.replace("USDT","")} –¥–æ ${time}</span>`;
      });
    } catch (e) {}
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è —Å–¥–µ–ª–∫–∏ –≤—Ä—É—á–Ω—É—é
  async function closeTrade(symbol) {
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–∫—Ä—ã—Ç—å —Å–¥–µ–ª–∫—É –ø–æ ${symbol}?`)) return;

    try {
      const response = await fetch(`/api/close-trade?symbol=${symbol}`, { method: 'POST' });
      if (response.ok) {
        updateDashboard();
      } else {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–¥–µ–ª–∫–∏");
      }
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞:", error);
    }
  }

  function toggleMenu() {
    const menu = document.getElementById('glassMenu');
    const icon = document.getElementById('menuIcon');

    if (menu.classList.contains('active')) {
      menu.classList.remove('active');
      icon.classList.remove('open');
      setTimeout(() => { menu.style.display = 'none'; }, 300);
      document.body.style.overflow = 'auto'; // –í–∫–ª—é—á–∞–µ–º —Å–∫—Ä–æ–ª–ª –æ–±—Ä–∞—Ç–Ω–æ
    } else {
      menu.style.display = 'flex';
      setTimeout(() => {
        menu.classList.add('active');
        icon.classList.add('open');
      }, 10);
      document.body.style.overflow = 'hidden'; // –í—ã–∫–ª—é—á–∞–µ–º —Å–∫—Ä–æ–ª–ª —Å–∞–π—Ç–∞
    }
  }

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ñ–æ–Ω
  document.getElementById('glassMenu').addEventListener('click', function(e) {
    if (e.target === this) toggleMenu();
  });

  updateDashboard();
  setInterval(updateDashboard, 2000);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>